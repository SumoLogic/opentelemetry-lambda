name: Build and upload artifacts

on:
  workflow_call:
    inputs:
      architecture:
        required: true
        type: string
      aws_region:
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      PUBLISH_COMMAND:
        required: true
      ARTIFACT_ARCHIVE:
        required: true
      PUBLISH:
        required: true
      LANGUAGE:
        required: true


jobs:
  create-lambda-layer-artifacts:
    name: Build and upload artifacts
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - uses: actions/setup-python@v2
        with:
          python-version: '3.8'
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ secrets.LANGUAGE }}-${{ architecture }}-artifacts
          path: ~/artifact
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ aws_region }}
      - name: Install AWS CLI
        run: |
          python -m pip install --upgrade pip
          pip install awscli
      - name: Create Lambda Layer - ${{ architecture }}
        run: ${{ secrets.PUBLISH_COMMAND }} ${{ architecture }} "${GITHUB_HEAD_REF}-${{ secrets.LANGUAGE }}-${{ architecture }}" "${GITHUB_HEAD_REF}-${{ secrets.LANGUAGE }}-${{ architecture }}-${{ aws_region }}" ~/artifact/${{ secrets.ARTIFACT_ARCHIVE }} layer-${{ architecture }}.zip ${{ secrets.PUBLISH }} ${{ aws_region }}
        working-directory: ${{ secrets.LANGUAGE }}
      - name: Clean s3
        if: always()
        run: |
          aws s3 rb --force s3://${GITHUB_HEAD_REF}-${{ secrets.LANGUAGE }}-${{ architecture }}-${{ aws_region }} --region ${{ aws_region }}
